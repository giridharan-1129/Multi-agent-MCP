version: '3.8'
services:
  neo4j:
    image: neo4j:5.15
    container_name: neo4j
    ports:
    - 7687:7687
    - 7474:7474
    environment:
      NEO4J_AUTH: neo4j/password
      NEO4J_PLUGINS: '["apoc"]'
    volumes:
    - neo4j_data:/data
    healthcheck:
      test:
      - CMD
      - cypher-shell
      - -u
      - neo4j
      - -p
      - password
      - RETURN 1
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
    - codebase_chat
  redis:
    image: redis:7-alpine
    container_name: redis
    ports:
    - 6379:6379
    command: redis-server --appendonly yes --requirepass redis_password
    volumes:
    - redis_data:/data
    healthcheck:
      test:
      - CMD
      - redis-cli
      - -a
      - redis_password
      - ping
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
    - codebase_chat
  postgres:
    image: postgres:15-alpine
    container_name: postgres
    ports:
    - 5432:5432
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres_password
      POSTGRES_DB: codebase_chat
    volumes:
    - postgres_data:/var/lib/postgresql/data
    - ./init.sql:/docker-entrypoint-initdb.d/init.sql
    healthcheck:
      test:
      - CMD-SHELL
      - pg_isready -U postgres
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
    - codebase_chat
  memory_service:
    build:
      context: .
      dockerfile: src/services/memory_service/Dockerfile
    container_name: memory_service
    ports:
    - 8005:8005
    environment:
      REDIS_URL: redis://:redis_password@redis:6379/0
      DATABASE_URL: postgresql://postgres:postgres_password@postgres:5432/codebase_chat
      LOG_LEVEL: INFO
      MEMORY_HOST: 0.0.0.0
      MEMORY_PORT: 8005
    healthcheck:
      test:
      - CMD
      - nc
      - -z
      - localhost
      - '8005'
      interval: 10s
      timeout: 5s
      retries: 3
    networks:
    - codebase_chat
  graph_query_service:
    build:
      context: .
      dockerfile: src/services/graph_query_service/Dockerfile
    container_name: graph_query_service
    ports:
    - 8003:8003
    environment:
      NEO4J_URI: bolt://neo4j:7687
      NEO4J_USER: neo4j
      NEO4J_PASSWORD: password
      LOG_LEVEL: INFO
      GRAPH_QUERY_HOST: 0.0.0.0
      GRAPH_QUERY_PORT: 8003
    healthcheck:
      test:
      - CMD
      - nc
      - -z
      - localhost
      - '8003'
      interval: 10s
      timeout: 5s
      retries: 3
    networks:
    - codebase_chat
  code_analyst_service:
    build:
      context: .
      dockerfile: src/services/code_analyst_service/Dockerfile
    container_name: code_analyst_service
    ports:
    - 8004:8004
    environment:
      NEO4J_URI: bolt://neo4j:7687
      NEO4J_USER: neo4j
      NEO4J_PASSWORD: password
      LOG_LEVEL: INFO
      CODE_ANALYST_HOST: 0.0.0.0
      CODE_ANALYST_PORT: 8004
    healthcheck:
      test:
      - CMD
      - nc
      - -z
      - localhost
      - '8004'
      interval: 10s
      timeout: 5s
      retries: 3
    networks:
    - codebase_chat
  indexer_service:
    build:
      context: .
      dockerfile: src/services/indexer_service/Dockerfile
    container_name: indexer_service
    ports:
    - 8002:8002
    environment:
      NEO4J_URI: bolt://neo4j:7687
      NEO4J_USER: neo4j
      NEO4J_PASSWORD: password
      LOG_LEVEL: INFO
      INDEXER_HOST: 0.0.0.0
      INDEXER_PORT: 8002
    volumes:
    - /tmp/repositories:/tmp/repositories
    healthcheck:
      test:
      - CMD
      - nc
      - -z
      - localhost
      - '8002'
      interval: 10s
      timeout: 5s
      retries: 3
    networks:
    - codebase_chat
  orchestrator_service:
    build:
      context: .
      dockerfile: src/services/orchestrator_service/Dockerfile
    container_name: orchestrator_service
    ports:
    - 8001:8001
    environment:
      MEMORY_SERVICE_URL: http://memory_service:8005
      GRAPH_QUERY_SERVICE_URL: http://graph_query_service:8003
      CODE_ANALYST_SERVICE_URL: http://code_analyst_service:8004
      INDEXER_SERVICE_URL: http://indexer_service:8002
      REDIS_URL: redis://:redis_password@redis:6379/1
      DATABASE_URL: postgresql://postgres:postgres_password@postgres:5432/codebase_chat
      LOG_LEVEL: INFO
      ORCHESTRATOR_HOST: 0.0.0.0
      ORCHESTRATOR_PORT: 8001
    healthcheck:
      test:
      - CMD
      - nc
      - -z
      - localhost
      - '8001'
      interval: 10s
      timeout: 5s
      retries: 3
    networks:
    - codebase_chat
  gateway:
    build:
      context: .
      dockerfile: docker/Dockerfile.gateway
    container_name: gateway
    ports:
    - 8000:8000
    environment:
      ORCHESTRATOR_SERVICE_URL: http://orchestrator_service:8001
      REDIS_URL: redis://:redis_password@redis:6379/2
      LOG_LEVEL: INFO
      GATEWAY_HOST: 0.0.0.0
      GATEWAY_PORT: 8000
    healthcheck:
      test:
      - CMD
      - nc
      - -z
      - localhost
      - '8000'
      interval: 10s
      timeout: 5s
      retries: 3
    networks:
    - codebase_chat
  streamlit:
    build:
      context: .
      dockerfile: docker/Dockerfile.streamlit
    container_name: streamlit
    ports:
    - 8501:8501
    environment:
      API_BASE: http://gateway:8000
      LOG_LEVEL: INFO
    healthcheck:
      test:
      - CMD
      - nc
      - -z
      - localhost
      - '8501'
      interval: 10s
      timeout: 5s
      retries: 3
    networks:
    - codebase_chat
volumes:
  neo4j_data:
    driver: local
  redis_data:
    driver: local
  postgres_data:
    driver: local
networks:
  codebase_chat:
    driver: bridge
