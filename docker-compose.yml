services:
  neo4j:
    image: neo4j:5.15
    container_name: neo4j
    ports:
    - 7687:7687
    - 7474:7474
    environment:
      NEO4J_AUTH: neo4j/password
      NEO4J_PLUGINS: '["apoc"]'
    volumes:
    - neo4j_data:/data
    healthcheck:
      test:
      - CMD
      - cypher-shell
      - -u
      - neo4j
      - -p
      - password
      - RETURN 1
      interval: 15s
      timeout: 10s
      retries: 5
      start_period: 30s
    networks:
    - codebase_chat
  redis:
    image: redis:7-alpine
    container_name: redis
    ports:
    - 6379:6379
    command: redis-server --appendonly yes --requirepass redis_password
    volumes:
    - redis_data:/data
    healthcheck:
      test:
      - CMD
      - redis-cli
      - -a
      - redis_password
      - ping
      interval: 15s
      timeout: 10s
      retries: 5
      start_period: 30s
    networks:
    - codebase_chat
  postgres:
    image: postgres:15-alpine
    container_name: postgres
    ports:
    - 5432:5432
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres_password
      POSTGRES_DB: codebase_chat
    volumes:
    - postgres_data:/var/lib/postgresql/data
    - ./init.sql:/docker-entrypoint-initdb.d/init.sql
    healthcheck:
      test:
      - CMD-SHELL
      - pg_isready -U postgres
      interval: 15s
      timeout: 10s
      retries: 5
      start_period: 30s
    networks:
    - codebase_chat
  memory_service:
    build:
      context: .
      dockerfile: docker/Dockerfile.memory
      args:
        SERVICE_PATH: src.services.memory_service.main
        SERVICE_PORT: 8005
    container_name: memory_service
    ports:
    - 8005:8005
    environment:
      REDIS_URL: redis://:redis_password@redis:6379/0
      DATABASE_URL: postgresql://postgres:postgres_password@postgres:5432/codebase_chat
      LOG_LEVEL: INFO
      MEMORY_HOST: 0.0.0.0
      MEMORY_PORT: 8005
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test:
      - CMD
      - nc
      - -z
      - localhost
      - '8005'
      interval: 15s
      timeout: 10s
      retries: 5
      start_period: 30s
    networks:
    - codebase_chat
  graph_query_service:
    build:
      context: .
      dockerfile: docker/Dockerfile.graph
      args:
        SERVICE_PATH: src.services.graph_query_service.main
        SERVICE_PORT: 8003
    container_name: graph_query_service
    ports:
    - 8003:8003
    environment:
      NEO4J_URI: bolt://neo4j:7687
      NEO4J_USER: neo4j
      NEO4J_PASSWORD: password
      LOG_LEVEL: INFO
      GRAPH_QUERY_HOST: 0.0.0.0
      GRAPH_QUERY_PORT: 8003
    depends_on:
      neo4j:
        condition: service_healthy
    healthcheck:
      test:
      - CMD
      - nc
      - -z
      - localhost
      - '8003'
      interval: 15s
      timeout: 10s
      retries: 5
      start_period: 30s
    networks:
    - codebase_chat
  code_analyst_service:
    build:
      context: .
      dockerfile: docker/Dockerfile.code
      args:
        SERVICE_PATH: src.services.code_analyst_service.main
        SERVICE_PORT: 8004
    container_name: code_analyst_service
    ports:
    - 8004:8004
    environment:
      NEO4J_URI: bolt://neo4j:7687
      NEO4J_USER: neo4j
      NEO4J_PASSWORD: password
      LOG_LEVEL: INFO
      CODE_ANALYST_HOST: 0.0.0.0
      CODE_ANALYST_PORT: 8004
    depends_on:
      neo4j:
        condition: service_healthy
    healthcheck:
      test:
      - CMD
      - nc
      - -z
      - localhost
      - '8004'
      interval: 15s
      timeout: 10s
      retries: 5
      start_period: 30s
    networks:
    - codebase_chat
  indexer_service:
    build:
      context: .
      dockerfile: docker/Dockerfile.indexer
      args:
        SERVICE_PATH: src.services.indexer_service.main
        SERVICE_PORT: 8002
    container_name: indexer_service
    ports:
    - 8002:8002
    environment:
      NEO4J_URI: bolt://neo4j:7687
      NEO4J_USER: neo4j
      NEO4J_PASSWORD: password
      LOG_LEVEL: INFO
      INDEXER_HOST: 0.0.0.0
      INDEXER_PORT: 8002
      PINECONE_API_KEY: ${PINECONE_API_KEY}
      COHERE_API_KEY: ${COHERE_API_KEY}
      OPENAI_API_KEY: ${OPENAI_API_KEY}
    depends_on:
      neo4j:
        condition: service_healthy
    volumes:
    - /tmp/repositories:/tmp/repositories
    healthcheck:
      test:
      - CMD
      - nc
      - -z
      - localhost
      - '8002'
      interval: 15s
      timeout: 10s
      retries: 5
      start_period: 30s
    networks:
    - codebase_chat
  orchestrator_service:
    build:
      context: .
      dockerfile: docker/Dockerfile.orchestrator
      args:
        SERVICE_PATH: src.services.orchestrator_service.main
        SERVICE_PORT: 8001
    container_name: orchestrator_service
    ports:
    - 8001:8001
    environment:
      MEMORY_SERVICE_URL: http://memory_service:8005
      GRAPH_QUERY_SERVICE_URL: http://graph_query_service:8003
      CODE_ANALYST_SERVICE_URL: http://code_analyst_service:8004
      INDEXER_SERVICE_URL: http://indexer_service:8002
      REDIS_URL: redis://:redis_password@redis:6379/1
      DATABASE_URL: postgresql://postgres:postgres_password@postgres:5432/codebase_chat
      LOG_LEVEL: INFO
      ORCHESTRATOR_HOST: 0.0.0.0
      ORCHESTRATOR_PORT: 8001
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      PINECONE_API_KEY: ${PINECONE_API_KEY}
      COHERE_API_KEY: ${COHERE_API_KEY}
    depends_on:
      memory_service:
        condition: service_healthy
      graph_query_service:
        condition: service_healthy
      code_analyst_service:
        condition: service_healthy
      indexer_service:
        condition: service_healthy
      redis:
        condition: service_healthy
      postgres:
        condition: service_healthy
    healthcheck:
      test:
      - CMD
      - nc
      - -z
      - localhost
      - '8001'
      interval: 15s
      timeout: 10s
      retries: 5
      start_period: 30s
    networks:
    - codebase_chat
  gateway:
    build:
      context: .
      dockerfile: docker/Dockerfile.gateway
    container_name: gateway
    ports:
    - 8000:8000
    environment:
      ORCHESTRATOR_SERVICE_URL: http://orchestrator_service:8001
      REDIS_URL: redis://:redis_password@redis:6379/2
      LOG_LEVEL: INFO
      GATEWAY_HOST: 0.0.0.0
      GATEWAY_PORT: 8000
    depends_on:
      orchestrator_service:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test:
      - CMD
      - nc
      - -z
      - localhost
      - '8000'
      interval: 15s
      timeout: 10s
      retries: 5
      start_period: 30s
    networks:
    - codebase_chat
  streamlit:
    build:
      context: .
      dockerfile: docker/Dockerfile.streamlit
    container_name: streamlit
    ports:
    - 8501:8501
    environment:
      API_BASE: http://gateway:8000
      ORCHESTRATOR_SERVICE_URL: http://orchestrator_service:8001
      INDEXER_SERVICE_URL: http://indexer_service:8002
      GRAPH_QUERY_SERVICE_URL: http://graph_query_service:8003
      LOG_LEVEL: INFO
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      PINECONE_API_KEY: ${PINECONE_API_KEY}
      COHERE_API_KEY: ${COHERE_API_KEY}
    depends_on:
      gateway:
        condition: service_healthy
      orchestrator_service:
        condition: service_healthy
      indexer_service:
        condition: service_healthy
    healthcheck:
      test:
      - CMD
      - nc
      - -z
      - localhost
      - '8501'
      interval: 15s
      timeout: 10s
      retries: 5
      start_period: 30s
    networks:
    - codebase_chat
volumes:
  neo4j_data:
    driver: local
  redis_data:
    driver: local
  postgres_data:
    driver: local
networks:
  codebase_chat:
    driver: bridge