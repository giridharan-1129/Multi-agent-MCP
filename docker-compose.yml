version: '3.8'

services:
  # Databases
  neo4j:
    image: neo4j:5.14-community
    container_name: multiagent-neo4j
    ports:
      - "7688:7687"
      - "7475:7474"
    environment:
      - NEO4J_AUTH=${NEO4J_USERNAME}/${NEO4J_PASSWORD}
    volumes:
      - neo4j_data:/var/lib/neo4j/data
      - neo4j_logs:/var/lib/neo4j/logs
    networks:
      - multiagent
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:7474"]
      interval: 10s
      timeout: 5s
      retries: 5

  redis:
    image: redis:7-alpine
    container_name: multiagent-redis
    ports:
      - "6379:6379"
    command: redis-server --appendonly yes --requirepass ${REDIS_PASSWORD:-redis_password}
    volumes:
      - redis_data:/data
    networks:
      - multiagent
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "${REDIS_PASSWORD:-redis_password}", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  postgres:
    image: postgres:15-alpine
    container_name: multiagent-postgres
    ports:
      - "5432:5432"
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-postgres_password}
      POSTGRES_DB: ${POSTGRES_DB:-codebase_chat}
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./init.sql:/docker-entrypoint-initdb.d/init.sql
    networks:
      - multiagent
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-postgres}"]
      interval: 10s
      timeout: 5s
      retries: 5

  # MCP Services
  memory_service:
    build:
      context: .
      dockerfile: services/memory_service/Dockerfile
    container_name: multiagent-memory
    ports:
      - "8005:8005"
    environment:
      - REDIS_URL=redis://:${REDIS_PASSWORD:-redis_password}@redis:6379/0
      - DATABASE_URL=postgresql://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD:-postgres_password}@postgres:5432/${POSTGRES_DB:-codebase_chat}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - SERVICE_PORT=8005
    depends_on:
      redis:
        condition: service_healthy
      postgres:
        condition: service_healthy
    networks:
      - multiagent
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8005/health"]
      interval: 10s
      timeout: 5s
      retries: 3

  graph_query_service:
    build:
      context: .
      dockerfile: services/graph_query_service/Dockerfile
    container_name: multiagent-graph-query
    ports:
      - "8003:8003"
    environment:
      - NEO4J_URI=bolt://neo4j:7687
      - NEO4J_USERNAME=${NEO4J_USERNAME}
      - NEO4J_PASSWORD=${NEO4J_PASSWORD}
      - NEO4J_DATABASE=${NEO4J_DATABASE}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - SERVICE_PORT=8003
    depends_on:
      neo4j:
        condition: service_healthy
    networks:
      - multiagent
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8003/health"]
      interval: 10s
      timeout: 5s
      retries: 3

  code_analyst_service:
    build:
      context: .
      dockerfile: services/code_analyst_service/Dockerfile
    container_name: multiagent-code-analyst
    ports:
      - "8004:8004"
    environment:
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - SERVICE_PORT=8004
    networks:
      - multiagent
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8004/health"]
      interval: 10s
      timeout: 5s
      retries: 3

  indexer_service:
    build:
      context: .
      dockerfile: services/indexer_service/Dockerfile
    container_name: multiagent-indexer
    ports:
      - "8002:8002"
    environment:
      - NEO4J_URI=bolt://neo4j:7687
      - NEO4J_USERNAME=${NEO4J_USERNAME}
      - NEO4J_PASSWORD=${NEO4J_PASSWORD}
      - NEO4J_DATABASE=${NEO4J_DATABASE}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - SERVICE_PORT=8002
    depends_on:
      neo4j:
        condition: service_healthy
    volumes:
      - /tmp/repositories:/tmp/repositories
    networks:
      - multiagent
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8002/health"]
      interval: 10s
      timeout: 5s
      retries: 3

  orchestrator_service:
    build:
      context: .
      dockerfile: services/orchestrator_service/Dockerfile
    container_name: multiagent-orchestrator
    ports:
      - "8001:8001"
    environment:
      - MEMORY_SERVICE_URL=http://memory_service:8005
      - GRAPH_QUERY_SERVICE_URL=http://graph_query_service:8003
      - CODE_ANALYST_SERVICE_URL=http://code_analyst_service:8004
      - INDEXER_SERVICE_URL=http://indexer_service:8002
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - SERVICE_PORT=8001
    depends_on:
      memory_service:
        condition: service_healthy
      graph_query_service:
        condition: service_healthy
      code_analyst_service:
        condition: service_healthy
      indexer_service:
        condition: service_healthy
    networks:
      - multiagent
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8001/health"]
      interval: 10s
      timeout: 5s
      retries: 3

  # API Gateway
  gateway:
    build:
      context: .
      dockerfile: docker/Dockerfile.gateway
    container_name: multiagent-gateway
    ports:
      - "8000:8000"
    environment:
      - ENVIRONMENT=${ENVIRONMENT:-production}
      - ORCHESTRATOR_SERVICE_URL=http://orchestrator_service:8001
      - REDIS_URL=redis://:${REDIS_PASSWORD:-redis_password}@redis:6379/1
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - OPENAI_MODEL=${OPENAI_MODEL:-gpt-4}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - GATEWAY_HOST=0.0.0.0
      - GATEWAY_PORT=8000
      - GATEWAY_RELOAD=${GATEWAY_RELOAD:-false}
    depends_on:
      orchestrator_service:
        condition: service_healthy
    volumes:
      - /tmp/repositories:/tmp/repositories
    networks:
      - multiagent
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      start_period: 20s
      retries: 3

  # Streamlit UI
  streamlit:
    build:
      context: .
      dockerfile: docker/Dockerfile.streamlit
    container_name: multiagent-streamlit
    ports:
      - "8501:8501"
    depends_on:
      - gateway
    networks:
      - multiagent
    volumes:
      - ./streamlit_app.py:/app/streamlit_app.py
      - ./mermaid_renderer.py:/app/mermaid_renderer.py
      - ./network_graph_renderer.py:/app/network_graph_renderer.py
      - ./relationship_mappings.py:/app/relationship_mappings.py
    environment:
      - PYTHONPATH=/app
      - API_BASE=http://gateway:8000

volumes:
  neo4j_data:
    driver: local
  neo4j_logs:
    driver: local
  redis_data:
    driver: local
  postgres_data:
    driver: local

networks:
  multiagent:
    driver: bridge